<!doctype html>
<html>

<head>
    <title>Genshin card game</title>
    <script src='normal.js'></script>
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" type="text/css" href="menu.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.4/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"></script>
    <script type="module">

        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import {
            getDatabase,
            set,
            ref,
            push,
            child,
            onValue,
            onChildAdded,
            update,
            get
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";



        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCSUQoYmYbmbkKoIbDQcQhOxnada13rBWY",
            authDomain: "memory-c1192.firebaseapp.com",
            projectId: "memory-c1192",
            storageBucket: "memory-c1192.appspot.com",
            messagingSenderId: "320978503728",
            appId: "1:320978503728:web:49c1ef1f72cd9a595745f5",
            measurementId: "G-QP4M89SW8F",
            databaseURL: "https://memory-c1192-default-rtdb.europe-west1.firebasedatabase.app/",
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const database = getDatabase(app);
        var pseudoG;
        var verif = document.querySelector('.verif');
        var formulaire = document.querySelector('.formulaire');
        var messages = [];
        var submit = document.querySelector("#submit");
        var messagesList = document.getElementById('messages-list');
        var stop = 0;
        
            setInterval(() => {
            if (stop == 0) {
                var user2 = auth.currentUser;
                if (user2) {
                    stop = 1;
                    var email = user2.email;
                    const li = document.createElement('h2');
                    li.textContent = "Connecté";
                    verif.appendChild(li);
                    formulaire.style.display = 'none'
                    const usersRef = ref(database, 'users');
                    const dbRef = ref(getDatabase());
                    var pseudoL = [];
                    get(child(dbRef, `users/`)).then((snapshot) => {
                        if (snapshot.exists()) {
                           // console.log("snapshot exit", pseudoG)
                            snapshot.forEach((childSnapshot) => {
                                // Récupération des données du message
                                var ps = childSnapshot.val();
                                //console.log("c'est ps.email", ps.email)
                               // console.log("c'est email", ps.email)
                                // Ajout du message au tableau
                                if (ps.email === email) {
                                    pseudoG = ps.pseudo;
                                    console.log("c'est son speudo", pseudoG)

                                }
                              //  console.log("pas de pseudo", pseudoG)
                                pseudoL.push(ps);
                                //messages = messages.map(i => Number(i));
                            });

                           // console.log(pseudoL[1].pseudo);
                        } else {
                            console.log("No data available");
                        }
                    }).catch((error) => {
                        console.error(error);
                    });
                }
            }

        }, 10);
       
        window.addEventListener("load", (event) => {
        submit.addEventListener('click', (e) => {
            var message = document.getElementById('message').value;
            var user = auth.currentUser;
            if (user) {

                var userId = user.uid;
                var userEmail = user.email;


                const id = push(child(ref(database), 'users/' + userId + '/messages')).key;
                set(ref(database, '/messages/' + id), {
                    message: message,
                    pseudo: pseudoG
                });


                //messages.push(message);
                document.getElementById('message').value = "";

                //alert('message has sent to ' + userEmail);

            } else {
                alert('You need to log in first');
            }
        });
        var truc = 0;
        setInterval(() => {
            var message = document.getElementById('message').value;
            var user = auth.currentUser;
            if (user) {
                var fin = document.querySelector(".end")
                var pts = document.querySelector(".point").textContent;
                if (truc == 0) {
                    if (fin.style.display == "unset") {
                        truc = 1;
                        var userId = user.uid;
                        var userEmail = user.email;


                        const id = push(child(ref(database), 'users/' + userId + '/messages')).key;
                        set(ref(database, '/messages/' + id), {
                            message: pts,
                            pseudo: pseudoG
                        });


                        //messages.push(message);
                        document.getElementById('message').value = "";

                        //alert('message has sent to ' + userEmail);

                    }
                }
            }



        }, 100);

        // Récupération de la référence à la base de données
        const messagesRef = ref(database, 'messages');
        const pseu = ref(database, 'users/');
        // Initialisation du tableau de messages
        //const messages = [];

        // Écoute des modifications sur le nœud "messages"
        onValue(messagesRef, (snapshot) => {
            messagesList = document.getElementById("messages-list");
            
            messages = [];

            // Parcours de tous les enfants de "messages"
            snapshot.forEach((childSnapshot) => {
                // Récupération des données du message
                const message = childSnapshot.val();
                // Ajout du message au tableau

                messages.push(message);
                //messages = messages.map(i => Number(i));
            });


            // Le tableau contient maintenant tous les messages stockés dans la base de données
            console.log(messages);


            //document.getElementById('messages-list').innerHTML = '';

            messages.sort((a, b) => b.message - a.message);

            //console.log(messages);
            
        });
        setInterval(() => {

        },);
        submitData.addEventListener('click', (e) => {

            var email = document.getElementById('email').value;
            var password = document.getElementById('psw').value;
            var pseudo = document.getElementById('psd').value;
            if (pseudoG == undefined || pseudoG == null) {
                pseudoG = document.getElementById('psd').value;
            }

            //sign up user
            createUserWithEmailAndPassword(auth, email, password, pseudo)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    // ... user.uid
                    set(ref(database, 'users/' + user.uid), {
                        email: email,
                        password: password,
                        pseudo: pseudo
                    })
                        .then(() => {
                            // Data saved successfully!
                            alert('user created successfully');


                        })
                        .catch((error) => {
                            // The write failed...
                            alert(error);
                        });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    // ..
                    alert(errorMessage);
                });
            const usersRef = ref(database, 'users');
            const dbRef = ref(getDatabase());
            var pseudoL = [];
            get(child(dbRef, `users/`)).then((snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        // Récupération des données du message
                        var ps = childSnapshot.val();
                        // Ajout du message au tableau
                        if (ps.email === email) {
                            pseudoG = ps.pseudo;
                            console.log("c'est son speudo", pseudoG)

                        }

                        pseudoL.push(ps);
                        //messages = messages.map(i => Number(i));
                    });

                    console.log(pseudoL[1].pseudo);
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });

        });
        document.querySelector("#deco").addEventListener('click', (e) => {
            //sign out user
            signOut(auth).then(() => {
                // Sign-out successful.
                formulaire.style.display = 'unset'
            }).catch((error) => {
                // An error happened.
            });
        })

        document.querySelector("#franchement").addEventListener('click', (e) => {

            var email = document.getElementById('email').value;
            var password = document.getElementById('psw').value;
            var pseudo = document.getElementById('psd').value;
            if (pseudoG == undefined || pseudoG == null) {
                pseudoG = document.getElementById('psd').value;
            }


            // log in user
            signInWithEmailAndPassword(auth, email, password, pseudo)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    // ...

                    // save log in details into real time database
                    var lgDate = new Date();
                    update(ref(database, 'users/' + user.uid), {
                        last_login: lgDate,
                    })
                        .then(() => {
                            // Data saved successfully!
                            alert('user logged in successfully');


                        })
                        .catch((error) => {
                            // The write failed...
                            alert(error);
                        });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert(errorMessage);
                });
            const usersRef = ref(database, 'users');
            const dbRef = ref(getDatabase());
            var pseudoL = [];
            get(child(dbRef, `users/`)).then((snapshot) => {
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        // Récupération des données du message
                        var ps = childSnapshot.val();
                        // Ajout du message au tableau
                        if (ps.email === email) {
                            pseudoG = ps.pseudo;
                            console.log("c'est son speudo", pseudoG)

                        }

                        pseudoL.push(ps);
                        //messages = messages.map(i => Number(i));
                    });

                    console.log(pseudoL[1].pseudo);
                } else {
                    console.log("No data available");
                }
            }).catch((error) => {
                console.error(error);
            });
        });


    })
    </script>
    <style>
        .formulaire {
            position: relative;
            z-index: 999;
        }

        #deco {
            z-index: 999;
            position: relative;
        }
    </style>
</head>

<body>
    <div class="verif">
        <button type="button" id="deco" name="deco" class="registerbtn">Déconnection</button>
    </div>
    <form class="formulaire">
        <div class="container">
            <h1>Register</h1>
            <p>Please fill in this form to create an account.</p>
            <hr>

            <label for="email"><b>Email</b></label>
            <input type="text" placeholder="Enter Email" id="email" required>

            <label><b>Password</b></label>
            <input type="password" placeholder="Password" id="psw" required>

            <label for="pseudo"><b>Pseudo</b></label>
            <input type="text" placeholder="Entre un Pseudo" id="psd" required>


            <hr>
            <p>By creating an account you agree to our <a href="#">Terms & Privacy</a>.</p>

            <button type="button" id="submitData" name="submitData" class="registerbtn">Inscription</button>
            <button type="button" id="franchement" name="franchement" class="registerbtn">Connexion</button>

            <textarea id="message" class="form-control type_msg" placeholder="Type your message..."></textarea>
            <button id="submit" class="input-group-text send_btn"><i class="fas fa-location-arrow"></i>
            </button>
        </div>

        <div class="container signin">
            <p>Already have an account? <a href="#">Sign in</a>.</p>
        </div>
    </form>
    <a href="https://chikage04.github.io/memory-impact/indexBIS.html">
        <button class="glow-button">
            <span class="glow2">Niveau: </span> Difficile</span>
        </button>
    </a>
    <a href="https://chikage04.github.io/memory-impact/index.html">
        <button class="glow-button" id="menu">
            <span>Menu:</span>
        </button>
    </a>

    <div class="info">
        <p class="point">0</p>

        <div id="timer">00:00</div>
    </div>
    <div class="nonead">
        <ul id="messages"></ul>
        <div class="zone_saisie">
            <!--<input id="m" /> <button onclick="send()">Send</button>-->
        </div>
    </div>
    <div class="nonead">
        <ul id="messages"></ul>
        <form class="zone_saisie">
            <input id="m" autocomplete="on" placeholder="Type a message and press Enter" required>
            <button type="submit">Send</button>
        </form>
    </div>
    <div class="end">
        <div>
            <p id="ending">Bravo tu as gagné !<br>Si tu le souhaites tu peux toujours rejouer pour essayer de faire une
                meilleur score, ou bien tenter un autre mode de jeux !!</p>
        </div>
        <a href="https://chikage04.github.io/memory-impact/indexEZ.html">
            <button class="glow-button" id="fin">
                <span>Recommencer</span>
            </button>
        </a>
    </div>
    <div class="parent">
        <div class="scene">

            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back">
                    <img class="truc">
                </div>
            </div>

            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"> <img class="truc"></div>
            </div>

            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"> <img class="truc"></div>
            </div>


            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>

        </div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div class="scene2">
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
        </div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div class="scene4">
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
        </div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div class="scene3">
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
            <div class="card">
                <div class="card__face card__face--front">
                    <img src="https://static.wikia.nocookie.net/gensin-impact/images/5/56/Dendrobium_Card_Back.png" />
                </div>
                <div class="card__face card__face--back"><img class="truc"></div>
            </div>
        </div>
    </div>

</body>

</html>